<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { color: #00769e; background-color: #f1f3f5; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #00769e; } /* Normal */
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #657422; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #00769e; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #00769e; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #00769e; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #5e5e5e; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>


  <!--radix_placeholder_meta_tags-->
  <title>Shinkansen</title>

  <meta property="description" itemprop="description" content="To animate some trains!"/>


  <!--  https://schema.org/Article -->
  <meta property="article:published" itemprop="datePublished" content="2022-08-08"/>
  <meta property="article:created" itemprop="dateCreated" content="2022-08-08"/>

  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="Shinkansen"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="To animate some trains!"/>
  <meta property="og:locale" content="en_US"/>

  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="Shinkansen"/>
  <meta property="twitter:description" content="To animate some trains!"/>

  <!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->

  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","output","date"]}},"value":[{"type":"character","attributes":{},"value":["Shinkansen"]},{"type":"character","attributes":{},"value":["To animate some trains!  \n"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained","code_folding","style"]}},"value":[{"type":"logical","attributes":{},"value":[false]},{"type":"logical","attributes":{},"value":[false]},{"type":"character","attributes":{},"value":["cayman"]}]}]},{"type":"character","attributes":{},"value":["08-08-2022"]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["project_charts/hokuriku_anim_elev.gif","project_charts/hokuriku_map_final.Rds","project_charts/raster_hills_japan_latlon.png","project_data/hokuriku_translated.csv","project_data/j_train_lat_lon_GCPbill.tsv","project_data/raw_rvest_data.Rds","shinkansen_files/anchor-4.2.2/anchor.min.js","shinkansen_files/bowser-1.9.3/bowser.min.js","shinkansen_files/distill-2.2.21/template.v2.js","shinkansen_files/figure-html5/unnamed-chunk-11-1.png","shinkansen_files/figure-html5/unnamed-chunk-12-1.png","shinkansen_files/figure-html5/unnamed-chunk-13-1.png","shinkansen_files/figure-html5/unnamed-chunk-14-1.gif","shinkansen_files/figure-html5/unnamed-chunk-15-1.gif","shinkansen_files/figure-html5/unnamed-chunk-16-1.gif","shinkansen_files/figure-html5/unnamed-chunk-6-1.png","shinkansen_files/figure-html5/unnamed-chunk-7-1.png","shinkansen_files/header-attrs-2.14.3/header-attrs.js","shinkansen_files/jquery-3.6.0/jquery-3.6.0.js","shinkansen_files/jquery-3.6.0/jquery-3.6.0.min.js","shinkansen_files/jquery-3.6.0/jquery-3.6.0.min.map","shinkansen_files/popper-2.6.0/popper.min.js","shinkansen_files/tippy-6.2.7/tippy-bundle.umd.min.js","shinkansen_files/tippy-6.2.7/tippy-light-border.css","shinkansen_files/tippy-6.2.7/tippy.css","shinkansen_files/tippy-6.2.7/tippy.umd.min.js","shinkansen_files/webcomponents-2.0.0/webcomponents.js"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

  <style type="text/css">

  body {
    background-color: white;
  }

  .pandoc-table {
    width: 100%;
  }

  .pandoc-table>caption {
    margin-bottom: 10px;
  }

  .pandoc-table th:not([align]) {
    text-align: left;
  }

  .pagedtable-footer {
    font-size: 15px;
  }

  d-byline .byline {
    grid-template-columns: 2fr 2fr;
  }

  d-byline .byline h3 {
    margin-block-start: 1.5em;
  }

  d-byline .byline .authors-affiliations h3 {
    margin-block-start: 0.5em;
  }

  .authors-affiliations .orcid-id {
    width: 16px;
    height:16px;
    margin-left: 4px;
    margin-right: 4px;
    vertical-align: middle;
    padding-bottom: 2px;
  }

  d-title .dt-tags {
    margin-top: 1em;
    grid-column: text;
  }

  .dt-tags .dt-tag {
    text-decoration: none;
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0em 0.4em;
    margin-right: 0.5em;
    margin-bottom: 0.4em;
    font-size: 70%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  d-article table.gt_table td,
  d-article table.gt_table th {
    border-bottom: none;
  }

  .html-widget {
    margin-bottom: 2.0em;
  }

  .l-screen-inset {
    padding-right: 16px;
  }

  .l-screen .caption {
    margin-left: 10px;
  }

  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .shaded-content {
    background: white;
  }

  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }

  .hidden {
    display: none !important;
  }

  d-article {
    padding-top: 2.5rem;
    padding-bottom: 30px;
  }

  d-appendix {
    padding-top: 30px;
  }

  d-article>p>img {
    width: 100%;
  }

  d-article h2 {
    margin: 1rem 0 1.5rem 0;
  }

  d-article h3 {
    margin-top: 1.5rem;
  }

  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }

  /* Tweak code blocks */

  d-article div.sourceCode code,
  d-article pre code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: auto;
  }

  d-article div.sourceCode {
    background-color: white;
  }

  d-article div.sourceCode pre {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }

  d-article pre {
    font-size: 12px;
    color: black;
    background: none;
    margin-top: 0;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  d-article pre a {
    border-bottom: none;
  }

  d-article pre a:hover {
    border-bottom: none;
    text-decoration: underline;
  }

  d-article details {
    grid-column: text;
    margin-bottom: 0.8em;
  }

  @media(min-width: 768px) {

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: visible !important;
  }

  d-article div.sourceCode pre {
    padding-left: 18px;
    font-size: 14px;
  }

  d-article pre {
    font-size: 14px;
  }

  }

  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  /* CSS for d-contents */

  .d-contents {
    grid-column: text;
    color: rgba(0,0,0,0.8);
    font-size: 0.9em;
    padding-bottom: 1em;
    margin-bottom: 1em;
    padding-bottom: 0.5em;
    margin-bottom: 1em;
    padding-left: 0.25em;
    justify-self: start;
  }

  @media(min-width: 1000px) {
    .d-contents.d-contents-float {
      height: 0;
      grid-column-start: 1;
      grid-column-end: 4;
      justify-self: center;
      padding-right: 3em;
      padding-left: 2em;
    }
  }

  .d-contents nav h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 1em;
  }

  .d-contents li {
    list-style-type: none
  }

  .d-contents nav > ul {
    padding-left: 0;
  }

  .d-contents ul {
    padding-left: 1em
  }

  .d-contents nav ul li {
    margin-top: 0.6em;
    margin-bottom: 0.2em;
  }

  .d-contents nav a {
    font-size: 13px;
    border-bottom: none;
    text-decoration: none
    color: rgba(0, 0, 0, 0.8);
  }

  .d-contents nav a:hover {
    text-decoration: underline solid rgba(0, 0, 0, 0.6)
  }

  .d-contents nav > ul > li > a {
    font-weight: 600;
  }

  .d-contents nav > ul > li > ul {
    font-weight: inherit;
  }

  .d-contents nav > ul > li > ul > li {
    margin-top: 0.2em;
  }


  .d-contents nav ul {
    margin-top: 0;
    margin-bottom: 0.25em;
  }

  .d-article-with-toc h2:nth-child(2) {
    margin-top: 0;
  }


  /* Figure */

  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }

  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }

  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }

  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }

  /* Citations */

  d-article .citation {
    color: inherit;
    cursor: inherit;
  }

  div.hanging-indent{
    margin-left: 1em; text-indent: -1em;
  }

  /* Citation hover box */

  .tippy-box[data-theme~=light-border] {
    background-color: rgba(250, 250, 250, 0.95);
  }

  .tippy-content > p {
    margin-bottom: 0;
    padding: 2px;
  }


  /* Tweak 1000px media break to show more text */

  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }

    .grid {
      grid-column-gap: 16px;
    }

    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }

  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }

    .grid {
      grid-column-gap: 32px;
    }
  }


  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */

  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Include appendix styles here so they can be overridden */

  d-appendix {
    contain: layout style;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-top: 60px;
    margin-bottom: 0;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0,0,0,0.5);
    padding-top: 60px;
    padding-bottom: 48px;
  }

  d-appendix h3 {
    grid-column: page-start / text-start;
    font-size: 15px;
    font-weight: 500;
    margin-top: 1em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.65);
  }

  d-appendix h3 + * {
    margin-top: 1em;
  }

  d-appendix ol {
    padding: 0 0 0 15px;
  }

  @media (min-width: 768px) {
    d-appendix ol {
      padding: 0 0 0 30px;
      margin-left: -30px;
    }
  }

  d-appendix li {
    margin-bottom: 1em;
  }

  d-appendix a {
    color: rgba(0, 0, 0, 0.6);
  }

  d-appendix > * {
    grid-column: text;
  }

  d-appendix > d-footnote-list,
  d-appendix > d-citation-list,
  d-appendix > distill-appendix {
    grid-column: screen;
  }

  /* Include footnote styles here so they can be overridden */

  d-footnote-list {
    contain: layout style;
  }

  d-footnote-list > * {
    grid-column: text;
  }

  d-footnote-list a.footnote-backlink {
    color: rgba(0,0,0,0.3);
    padding-left: 0.5em;
  }



  /* Anchor.js */

  .anchorjs-link {
    /*transition: all .25s linear; */
    text-decoration: none;
    border-bottom: none;
  }
  *:hover > .anchorjs-link {
    margin-left: -1.125em !important;
    text-decoration: none;
    border-bottom: none;
  }

  /* Social footer */

  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }

  .disqus-comments {
    margin-right: 30px;
  }

  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }

  #disqus_thread {
    margin-top: 30px;
  }

  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }

  .article-sharing a:hover {
    border-bottom: none;
  }

  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }

  .subscribe p {
    margin-bottom: 0.5em;
  }


  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }


  .sidebar-section.custom {
    font-size: 12px;
    line-height: 1.6em;
  }

  .custom p {
    margin-bottom: 0.5em;
  }

  /* Styles for listing layout (hide title) */
  .layout-listing d-title, .layout-listing .d-title {
    display: none;
  }

  /* Styles for posts lists (not auto-injected) */


  .posts-with-sidebar {
    padding-left: 45px;
    padding-right: 45px;
  }

  .posts-list .description h2,
  .posts-list .description p {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }

  .posts-list .description h2 {
    font-weight: 700;
    border-bottom: none;
    padding-bottom: 0;
  }

  .posts-list h2.post-tag {
    border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    padding-bottom: 12px;
  }
  .posts-list {
    margin-top: 60px;
    margin-bottom: 24px;
  }

  .posts-list .post-preview {
    text-decoration: none;
    overflow: hidden;
    display: block;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding: 24px 0;
  }

  .post-preview-last {
    border-bottom: none !important;
  }

  .posts-list .posts-list-caption {
    grid-column: screen;
    font-weight: 400;
  }

  .posts-list .post-preview h2 {
    margin: 0 0 6px 0;
    line-height: 1.2em;
    font-style: normal;
    font-size: 24px;
  }

  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.4em;
    font-size: 16px;
  }

  .posts-list .post-preview .thumbnail {
    box-sizing: border-box;
    margin-bottom: 24px;
    position: relative;
    max-width: 500px;
  }
  .posts-list .post-preview img {
    width: 100%;
    display: block;
  }

  .posts-list .metadata {
    font-size: 12px;
    line-height: 1.4em;
    margin-bottom: 18px;
  }

  .posts-list .metadata > * {
    display: inline-block;
  }

  .posts-list .metadata .publishedDate {
    margin-right: 2em;
  }

  .posts-list .metadata .dt-authors {
    display: block;
    margin-top: 0.3em;
    margin-right: 2em;
  }

  .posts-list .dt-tags {
    display: block;
    line-height: 1em;
  }

  .posts-list .dt-tags .dt-tag {
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0.3em 0.4em;
    margin-right: 0.2em;
    margin-bottom: 0.4em;
    font-size: 60%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  .posts-list img {
    opacity: 1;
  }

  .posts-list img[data-src] {
    opacity: 0;
  }

  .posts-more {
    clear: both;
  }


  .posts-sidebar {
    font-size: 16px;
  }

  .posts-sidebar h3 {
    font-size: 16px;
    margin-top: 0;
    margin-bottom: 0.5em;
    font-weight: 400;
    text-transform: uppercase;
  }

  .sidebar-section {
    margin-bottom: 30px;
  }

  .categories ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }

  .categories li {
    color: rgba(0, 0, 0, 0.8);
    margin-bottom: 0;
  }

  .categories li>a {
    border-bottom: none;
  }

  .categories li>a:hover {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  }

  .categories .active {
    font-weight: 600;
  }

  .categories .category-count {
    color: rgba(0, 0, 0, 0.4);
  }


  @media(min-width: 768px) {
    .posts-list .post-preview h2 {
      font-size: 26px;
    }
    .posts-list .post-preview .thumbnail {
      float: right;
      width: 30%;
      margin-bottom: 0;
    }
    .posts-list .post-preview .description {
      float: left;
      width: 45%;
    }
    .posts-list .post-preview .metadata {
      float: left;
      width: 20%;
      margin-top: 8px;
    }
    .posts-list .post-preview p {
      margin: 0 0 12px 0;
      line-height: 1.5em;
      font-size: 16px;
    }
    .posts-with-sidebar .posts-list {
      float: left;
      width: 75%;
    }
    .posts-with-sidebar .posts-sidebar {
      float: right;
      width: 20%;
      margin-top: 60px;
      padding-top: 24px;
      padding-bottom: 24px;
    }
  }


  /* Improve display for browsers without grid (IE/Edge <= 15) */

  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }

  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }

  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }

  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }

  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }

  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }


  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }

  .downlevel .footnotes ol {
    padding-left: 13px;
  }

  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }

  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }

  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }

  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  .downlevel .posts-list .post-preview {
    color: inherit;
  }



  </style>

  <script type="application/javascript">

  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }

  // show body when load is complete
  function on_load_complete() {

    // add anchors
    if (window.anchors) {
      window.anchors.options.placement = 'left';
      window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
    }


    // set body to visible
    document.body.style.visibility = 'visible';

    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }

    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }

  function init_distill() {

    init_common();

    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);

    // create d-title
    $('.d-title').changeElementType('d-title');

    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);

    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();

    // move posts container into article
    $('.posts-container').appendTo($('d-article'));

    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');

    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;

    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();

    // move refs into #references-listing
    $('#references-listing').replaceWith($('#refs'));

    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-contents a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });

    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');

    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {

      // capture layout
      var layout = $(this).attr('data-layout');

      // apply layout to markdown level block elements
      var elements = $(this).children().not('details, div.sourceCode, pre, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });


      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });

    // remove code block used to force  highlighting css
    $('.distill-force-highlighting-css').parent().remove();

    // remove empty line numbers inserted by pandoc when using a
    // custom syntax highlighting theme
    $('code.sourceCode a:empty').remove();

    // load distill framework
    load_distill_framework();

    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {

      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;

      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');

      // article with toc class
      $('.d-contents').parent().addClass('d-article-with-toc');

      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

      // add orcid ids
      $('.authors-affiliations').find('.author').each(function(i, el) {
        var orcid_id = front_matter.authors[i].orcidID;
        if (orcid_id) {
          var a = $('<a></a>');
          a.attr('href', 'https://orcid.org/' + orcid_id);
          var img = $('<img></img>');
          img.addClass('orcid-id');
          img.attr('alt', 'ORCID ID');
          img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
          a.append(img);
          $(this).append(a);
        }
      });

      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }

      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");

      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }

       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }

      // remove d-appendix and d-footnote-list local styles
      $('d-appendix > style:first-child').remove();
      $('d-footnote-list > style:first-child').remove();

      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();

      // hoverable references
      $('span.citation[data-cites]').each(function() {
        if ($(this).children()[0].nodeName == "D-FOOTNOTE") {
          var fn = $(this).children()[0]
          $(this).html(fn.shadowRoot.querySelector("sup"))
          $(this).id = fn.id
          fn.remove()
        }
        var refs = $(this).attr('data-cites').split(" ");
        var refHtml = refs.map(function(ref) {
          return "<p>" + $('#ref-' + ref).html() + "</p>";
        }).join("\n");
        window.tippy(this, {
          allowHTML: true,
          content: refHtml,
          maxWidth: 500,
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        });
      });

      // fix footnotes in tables (#411)
      // replacing broken distill.pub feature
      $('table d-footnote').each(function() {
        // we replace internal showAtNode methode which is triggered when hovering a footnote
        this.hoverBox.showAtNode = function(node) {
          // ported from https://github.com/distillpub/template/pull/105/files
          calcOffset = function(elem) {
              let x = elem.offsetLeft;
              let y = elem.offsetTop;
              // Traverse upwards until an `absolute` element is found or `elem`
              // becomes null.
              while (elem = elem.offsetParent && elem.style.position != 'absolute') {
                  x += elem.offsetLeft;
                  y += elem.offsetTop;
              }

              return { left: x, top: y };
          }
          // https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/offsetTop
          const bbox = node.getBoundingClientRect();
          const offset = calcOffset(node);
          this.show([offset.left + bbox.width, offset.top + bbox.height]);
        }
      })

      // clear polling timer
      clearInterval(tid);

      // show body now that everything is ready
      on_load_complete();
    }

    var tid = setInterval(distill_post_process, 50);
    distill_post_process();

  }

  function init_downlevel() {

    init_common();

     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));

    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;

    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();

    // remove toc
    $('.d-contents').remove();

    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });


    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);

    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();

    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });

    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));

    $('body').addClass('downlevel');

    on_load_complete();
  }


  function init_common() {

    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};

        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });

        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);

    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});

    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      // ignore leaflet img layers (#106)
      figures = figures.filter(':not(img[class*="leaflet"])')
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });

      }
    });

    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });

    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace(/^index[.]html/, "./"));
      });
    }

    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');

    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");

    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();

    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });

  </script>

  <!--/radix_placeholder_distill-->
  <script src="shinkansen_files/header-attrs-2.14.3/header-attrs.js"></script>
  <script src="shinkansen_files/jquery-3.6.0/jquery-3.6.0.min.js"></script>
  <script src="shinkansen_files/popper-2.6.0/popper.min.js"></script>
  <link href="shinkansen_files/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="shinkansen_files/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="shinkansen_files/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="shinkansen_files/anchor-4.2.2/anchor.min.js"></script>
  <script src="shinkansen_files/bowser-1.9.3/bowser.min.js"></script>
  <script src="shinkansen_files/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="shinkansen_files/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Shinkansen","description":"To animate some trains!","authors":[],"publishedDate":"2022-08-08T00:00:00.000+10:00"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Shinkansen</h1>
<!--radix_placeholder_categories-->
<!--/radix_placeholder_categories-->
<p><p>To animate some trains!</p></p>
</div>


<div class="d-article">
<h1 id="the-better-kind-of-bullets">The better kind of bullets</h1>
<div class="layout-chunk" data-layout="l-screen-inset">
<p><img src="project_charts/hokuriku_anim_elev.gif" /><!-- --></p>
</div>
<p>After returning from Japan feeling bereft of high-tech public
transport options, I started a project that would chart the movement of
shinkansen (bullet trains) across Japan in near real time. Whereas sites
like <a href="http://www.demap.info/tetsudonow/">tetsudonow</a> display
excellent real-time interactive metro line service animations, I wanted
to see trains running over a larger spatial scale. Real time
interactivity is a longer-term goal.</p>
<p>Starting from a single column of station names and stop times, this
turned out to be a tricky undertaking, involving date/time manipulation,
world map data, and rendering non-standard text and emojis wrapped as
animations.</p>
<p>Below, instead of walking through every step, I outline the main
problems I encountered and my solutions. Anyone interested in the
grizzly details can read my comments in the code chunks.</p>
<p>The project required four main components:</p>
<ul>
<li><strong>scraping</strong> real timetable data from <a
href="https://world.jorudan.co.jp/mln/en/?sub_lang=nosub">jorudan.co.jp</a>,</li>
<li><strong>mapping</strong> latitude longitude and elevation data to
recreate the train route and surrounding topography,</li>
<li><strong>animating</strong> train icons according to the timetable
data, and</li>
<li><strong>calculating</strong> the unpublished passage times for
express trains through non-stopping stations.</li>
</ul>
<h1 id="scraping-timetable-data">Scraping timetable data</h1>
<p>The selected timetable is for the Tokyo-Nagano-Kanazawa (‘Hokuriku’)
line, during the time window 1-7pm on 22 March 2020. There are six
services departing Tokyo on this timetable, labelled service 3-8. Using
the rvest library we read the table data from the timetable url.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://rvest.tidyverse.org/'>rvest</a></span><span class='op'>)</span></span>
<span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://lubridate.tidyverse.org'>lubridate</a></span><span class='op'>)</span></span>
<span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://tidyverse.tidyverse.org'>tidyverse</a></span><span class='op'>)</span></span></code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>l1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.files.html'>list.files</a></span><span class='op'>(</span><span class='st'>'project_data/'</span>, pattern<span class='op'>=</span><span class='st'>'Rds'</span><span class='op'>)</span></span>
<span></span>
<span><span class='kw'>if</span><span class='op'>(</span><span class='st'>'raw_rvest_data.Rds'</span> <span class='op'><a href='https://rdrr.io/r/base/match.html'>%in%</a></span> <span class='va'>l1</span><span class='op'>)</span><span class='op'>{</span></span>
<span>  <span class='va'>p1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/readRDS.html'>readRDS</a></span><span class='op'>(</span><span class='st'>'project_data/raw_rvest_data.Rds'</span><span class='op'>)</span></span>
<span>  <span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='st'>'Reading from local file to avoid "digital rot"!'</span><span class='op'>)</span></span>
<span>  <span class='op'>}</span><span class='kw'>else</span><span class='op'>{</span></span>
<span>    </span>
<span><span class='va'>url</span> <span class='op'>&lt;-</span> <span class='st'>"https://www.jorudan.co.jp/time/cgi/time.cgi?Csg = 0&amp;Sok = 1&amp;pg = 21&amp;rf = tm&amp;lnm = %A4%A2%A4%B5%A4%DE613%B9%E6%28E7%2FW7%B7%CF%29%28%C4%B9%CC%EE%B9%D4%29&amp;rnm = %CB%CC%CE%A6%BF%B7%B4%B4%C0%FE&amp;eki1 = %C5%EC%B5%FE&amp;eki2 = D%B6%E2%C2%F4&amp;Dym = 202203&amp;Ddd = 14&amp;Dhh = 14&amp;Dmn = 24&amp;Dw = 0"</span></span>
<span></span>
<span><span class='va'>p1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='http://xml2.r-lib.org/reference/read_xml.html'>read_html</a></span><span class='op'>(</span><span class='va'>url</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://rvest.tidyverse.org/reference/rename.html'>html_nodes</a></span><span class='op'>(</span><span class='st'>'td'</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://rvest.tidyverse.org/reference/html_text.html'>html_text</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://tibble.tidyverse.org/reference/as_tibble.html'>as_tibble</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>value <span class='op'>=</span> <span class='fu'><a href='https://stringr.tidyverse.org/reference/str_remove.html'>str_remove_all</a></span><span class='op'>(</span><span class='va'>value</span>,  <span class='st'>"\n"</span><span class='op'>)</span><span class='op'>)</span></span>
<span>  </span>
<span><span class='fu'><a href='https://rdrr.io/r/base/readRDS.html'>saveRDS</a></span><span class='op'>(</span><span class='va'>p1</span>, file<span class='op'>=</span><span class='st'>'project_data/raw_rvest_data.Rds'</span><span class='op'>)</span></span>
<span></span>
<span><span class='op'>}</span></span></code></pre>
</div>
<pre><code>[1] &quot;Reading from local file to avoid \&quot;digital rot\&quot;!&quot;</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='va'>p1</span>,n<span class='op'>=</span><span class='fl'>20</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code># A tibble: 162 × 1
   value           
   &lt;chr&gt;           
 1 &quot;■&quot;             
 2 &quot;東京&quot;          
 3 &quot; 13:04発&quot;      
 4 &quot; 13:24発&quot;      
 5 &quot; 14:04発&quot;      
 6 &quot; 14:24発&quot;      
 7 &quot; 15:04発&quot;      
 8 &quot; 15:24発&quot;      
 9 &quot;&quot;              
10 &quot;■&quot;             
11 &quot;上野&quot;          
12 &quot;13:09着13:10発&quot;
13 &quot;13:29着13:30発&quot;
14 &quot;14:09着14:10発&quot;
15 &quot;14:29着14:30発&quot;
16 &quot;15:09着15:10発&quot;
17 &quot;15:29着15:30発&quot;
18 &quot;&quot;              
19 &quot;■&quot;             
20 &quot;大宮&quot;          
# … with 142 more rows
# ℹ Use `print(n = ...)` to see more rows</code></pre>
</div>
<p>The scraped data is a single vector in repeating units of 9 rows. To
wrangle this into a timetable we force it into a matrix of 9 columns.
This gives every second station. The interspersed stations are in rows
10-18. To create the final timetable we assign odd and even row numbers
then interleave the two tables:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>jikoku</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span></span>
<span>  </span>
<span>  <span class='co'>#Table 1 odd number stops</span></span>
<span>  <span class='fu'><a href='https://tibble.tidyverse.org/reference/as_tibble.html'>as_tibble</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/t.html'>t</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='va'>p1</span><span class='op'>$</span><span class='va'>value</span>, ncol  <span class='op'>=</span>  <span class='fl'>9</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://tibble.tidyverse.org/reference/as_tibble.html'>as_tibble</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>V1</span><span class='op'>:</span><span class='va'>V9</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>order  <span class='op'>=</span>  <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>1</span>,  <span class='fl'>2</span><span class='op'>*</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>.</span><span class='op'>)</span><span class='op'>)</span>,  <span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span> </span>
<span>  <span class='co'>#Table 2 even number stops </span></span>
<span>  <span class='fu'><a href='https://tibble.tidyverse.org/reference/as_tibble.html'>as_tibble</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/t.html'>t</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='va'>p1</span><span class='op'>$</span><span class='va'>value</span>, ncol  <span class='op'>=</span>  <span class='fl'>9</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='fu'><a href='https://tibble.tidyverse.org/reference/as_tibble.html'>as_tibble</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>V10</span><span class='op'>:</span><span class='va'>V18</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>order  <span class='op'>=</span>  <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>2</span>,  <span class='fl'>2</span><span class='op'>*</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>.</span><span class='op'>)</span><span class='op'>)</span>,  <span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='fu'>magrittr</span><span class='fu'>::</span><span class='fu'><a href='https://magrittr.tidyverse.org/reference/aliases.html'>set_colnames</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span><span class='st'>'V'</span>, <span class='fl'>1</span><span class='op'>:</span><span class='fl'>9</span><span class='op'>)</span>, <span class='st'>'order'</span><span class='op'>)</span><span class='op'>)</span> </span>
<span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#Arrange by row number</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>order</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>V2</span>, <span class='va'>order</span>, <span class='fu'><a href='https://tidyselect.r-lib.org/reference/everything.html'>everything</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='op'>-</span><span class='va'>V1</span>, <span class='op'>-</span><span class='va'>V9</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span>Station <span class='op'>=</span> <span class='va'>V2</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code># A tibble: 18 × 8
   Station        order V3             V4      V5    V6    V7    V8   
   &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;          &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
 1 東京               1  13:04発        13:24…  14:…  14:…  15:…  15:…
 2 上野               2 13:09着13:10発 13:29…  14:0… 14:2… 15:0… 15:2…
 3 大宮               3 13:28着13:29発 13:48…  14:2… 14:4… 15:2… 15:4…
 4 熊谷               4 13:41着13:42発 ↓       14:4… ↓     15:4… ↓    
 5 本庄早稲田         5 13:50着13:51発 ↓       14:5… ↓     15:5… ↓    
 6 高崎               6 14:00着14:01発 14:14…  15:0… 15:1… 16:0… 16:1…
 7 安中榛名           7 ↓              ↓       15:0… ↓     ↓     ↓    
 8 軽井沢             8 14:16着14:17発 ↓       15:2… ↓     16:1… 16:2…
 9 佐久平             9 14:25着14:26発 ↓       15:3… ↓     16:2… ↓    
10 上田              10 14:35着14:36発 ↓       15:3… ↓     16:3… ↓    
11 長野              11 14:47着        14:51…  15:5… 15:5… 16:4… 16:5…
12 飯山              12                15:04…        ↓           17:0…
13 上越妙高          13                15:15…        16:1…       17:1…
14 糸魚川            14                15:28…        16:2…       17:3…
15 黒部宇奈月温泉    15                15:43…        16:4…       17:4…
16 富山              16                15:56…        16:5…       17:5…
17 新高岡            17                16:05…        17:0…       18:0…
18 金沢              18                16:19…        17:1…       18:2…</code></pre>
</div>
<p>Now we reshape the timetable into long format, and separate the times
for station arrival (着) and departure (発) into two columns, before
spreading the data back into a readable timetable with each service as a
new column. The express (non-stopping) stations are now encoded as NA
instead of “↓”.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>jikoku_clean</span> <span class='op'>&lt;-</span> <span class='va'>jikoku</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://tidyr.tidyverse.org/reference/gather.html'>gather</a></span><span class='op'>(</span><span class='va'>key</span>, <span class='va'>value</span>, <span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>Station</span>, <span class='va'>order</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>key <span class='op'>=</span> <span class='fu'><a href='https://stringr.tidyverse.org/reference/str_replace.html'>str_replace</a></span><span class='op'>(</span><span class='va'>key</span>, <span class='st'>'V'</span>, <span class='st'>'service_'</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span>service <span class='op'>=</span> <span class='va'>key</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>value <span class='op'>=</span> <span class='fu'><a href='https://stringr.tidyverse.org/reference/str_replace.html'>str_replace</a></span><span class='op'>(</span><span class='va'>value</span>, <span class='st'>"↓"</span>, <span class='cn'>NA_character_</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/separate.html'>separate</a></span><span class='op'>(</span><span class='va'>value</span>,  into <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'arr'</span>, <span class='st'>'dpt'</span><span class='op'>)</span>, sep <span class='op'>=</span> <span class='st'>"着"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#move into the dpt column any data in arrival column containing departure information ('発'):</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>dpt  <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='fu'><a href='https://stringr.tidyverse.org/reference/str_detect.html'>str_detect</a></span><span class='op'>(</span><span class='va'>arr</span>, <span class='st'>'発'</span><span class='op'>)</span>, <span class='va'>arr</span>, <span class='va'>dpt</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>arr <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='fu'><a href='https://stringr.tidyverse.org/reference/str_detect.html'>str_detect</a></span><span class='op'>(</span><span class='va'>arr</span>, <span class='st'>'発'</span><span class='op'>)</span>,  <span class='cn'>NA</span>, <span class='va'>arr</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#drop the kanji:</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>dpt  <span class='op'>=</span>  <span class='fu'><a href='https://stringr.tidyverse.org/reference/str_remove.html'>str_remove_all</a></span><span class='op'>(</span><span class='va'>dpt</span>, <span class='st'>'発'</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#create a longer-format table to separate arr and dpt rows:</span></span>
<span>  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/gather.html'>gather</a></span><span class='op'>(</span><span class='va'>key</span>, <span class='va'>value</span>, <span class='va'>arr</span>, <span class='va'>dpt</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>order</span>, <span class='va'>Station</span>, <span class='va'>value</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://rdrr.io/r/stats/na.fail.html'>na.omit</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#create a wide-format table with service ('service') as new column names:</span></span>
<span>  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/spread.html'>spread</a></span><span class='op'>(</span><span class='va'>service</span>, <span class='va'>value</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>order</span><span class='op'>)</span> </span>
<span></span>
<span><span class='co'>#NB because Japanese font doesn't seem to render on interactive tables, for ease of viewing I drop Station column from output:</span></span>
<span><span class='va'>jikoku_clean</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>Station</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code># A tibble: 35 × 8
   order key   service_3 service_4 service_5 service_6 servi…¹ servi…²
   &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;   &lt;chr&gt;  
 1     1 dpt    13:04     13:24     14:04     14:24     15:04   15:24 
 2     2 arr   13:09     13:29     14:09     14:29     15:09   15:29  
 3     2 dpt   13:10     13:30     14:10     14:30     15:10   15:30  
 4     3 arr   13:28     13:48     14:28     14:48     15:28   15:48  
 5     3 dpt   13:29     13:49     14:29     14:49     15:29   15:49  
 6     4 arr   13:41     &lt;NA&gt;      14:41     &lt;NA&gt;      15:41   &lt;NA&gt;   
 7     4 dpt   13:42     &lt;NA&gt;      14:42     &lt;NA&gt;      15:42   &lt;NA&gt;   
 8     5 arr   13:50     &lt;NA&gt;      14:50     &lt;NA&gt;      15:50   &lt;NA&gt;   
 9     5 dpt   13:51     &lt;NA&gt;      14:51     &lt;NA&gt;      15:51   &lt;NA&gt;   
10     6 arr   14:00     14:14     15:00     15:14     16:00   16:12  
# … with 25 more rows, and abbreviated variable names ¹​service_7,
#   ²​service_8
# ℹ Use `print(n = ...)` to see more rows</code></pre>
</div>
<h1 id="geographic-maps">Geographic maps</h1>
<p>This step requires the plotting coordinates for Honshu island, and
GPS coordinates and English translations for the Hokuriku line
stations.</p>
<h3 id="plot-the-land-mass">Plot the land mass</h3>
<p>Using the maps library we can extract coordinates for Japan, then use
ggplot with <code>coord_quickmap()</code> to flatten the latitude and
longitude into 2D space. Somehow colouring the plot background blue
(‘theme_sea’) requires about as much code as does the much more
complicated mapping function….</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>maps</span><span class='op'>)</span></span>
<span><span class='va'>JPAN</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/map_data.html'>map_data</a></span><span class='op'>(</span><span class='st'>"world"</span><span class='op'>)</span>, <span class='va'>region</span><span class='op'>==</span><span class='st'>"Japan"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/as_tibble.html'>as_tibble</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>jp_map</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='va'>JPAN</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>long</span>, y <span class='op'>=</span> <span class='va'>lat</span>, group <span class='op'>=</span> <span class='va'>group</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_polygon.html'>geom_polygon</a></span><span class='op'>(</span>fill <span class='op'>=</span> <span class='st'>"white"</span>, colour <span class='op'>=</span> <span class='st'>"black"</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/coord_map.html'>coord_quickmap</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>theme_sea</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggtheme.html'>theme_classic</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>panel.background <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_rect</a></span><span class='op'>(</span>fill<span class='op'>=</span><span class='st'>"light blue"</span><span class='op'>)</span>,</span>
<span>                                     legend.position <span class='op'>=</span> <span class='st'>'bottom'</span><span class='op'>)</span> <span class='co'># &lt;- required for later</span></span>
<span></span>
<span><span class='va'>jp_map</span> <span class='op'>+</span> <span class='va'>theme_sea</span></span></code></pre>
</div>
<p><img src="shinkansen_files/figure-html5/unnamed-chunk-6-1.png" width="624" /></p>
</div>
<h3 id="city-gps-points">City GPS points</h3>
<p>Next we need the google maps API to search the latitude and longitude
of each city on the line. This can be costly for big projects. Anyone
trying to recreate this project can use the supplied data (github)
instead of running the <code>geocode()</code> commands.</p>
<p>For this step I borrowed heavily from this blog post: <a
href="https://www.littlemissdata.com/blog/maps"
class="uri">https://www.littlemissdata.com/blog/maps</a> and this <a
href="https://stackoverflow.com/questions/32994634/this-api-project-is-not-authorized-to-use-this-api-please-ensure-that-this-api">SO
thread</a>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'>#Read table of translated station names</span></span>
<span><span class='va'>hokuriku</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://readr.tidyverse.org/reference/read_delim.html'>read_csv</a></span><span class='op'>(</span><span class='st'>'project_data/hokuriku_translated.csv'</span>, show_col_types <span class='op'>=</span> <span class='cn'>F</span>, col_names  <span class='op'>=</span>  <span class='cn'>TRUE</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'>#devtools::install_github("dkahle/ggmap",  ref  =  "tidyup",  force = TRUE)</span></span>
<span></span>
<span><span class='co'>#Load the library</span></span>
<span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='st'><a href='https://github.com/dkahle/ggmap'>"ggmap"</a></span><span class='op'>)</span></span>
<span></span>
<span><span class='co'>#Set the Google Maps API</span></span>
<span><span class='co'>#  httr::set_config(httr::config(http_version = 0))</span></span>
<span></span>
<span><span class='co'>#Set your API Key </span></span>
<span><span class='fu'><a href='https://rdrr.io/pkg/ggmap/man/register_google.html'>register_google</a></span><span class='op'>(</span>key  <span class='op'>=</span>  <span class='st'>"&lt;&lt;your key here&gt;&gt;"</span><span class='op'>)</span></span>
<span></span>
<span><span class='fu'><a href='https://rdrr.io/pkg/ggmap/man/geocode.html'>geocode</a></span><span class='op'>(</span><span class='st'>'Tokyo,  Japan'</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<p>Now to save some money:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>ll_files</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.files.html'>list.files</a></span><span class='op'>(</span> <span class='st'>'project_data/'</span>, pattern<span class='op'>=</span><span class='st'>'j_train_lat_lon_GCPbill'</span><span class='op'>)</span></span>
<span></span>
<span><span class='kw'>if</span><span class='op'>(</span><span class='st'>'j_train_lat_lon_GCPbill.tsv'</span> <span class='op'><a href='https://rdrr.io/r/base/match.html'>%in%</a></span> <span class='va'>ll_files</span><span class='op'>)</span><span class='op'>{</span></span>
<span>  <span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='st'>'lat_long exists, dont rerun GCP billing'</span><span class='op'>)</span></span>
<span>  </span>
<span>  <span class='va'>jikoku_gps</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://readr.tidyverse.org/reference/read_delim.html'>read_tsv</a></span><span class='op'>(</span><span class='st'>'project_data/j_train_lat_lon_GCPbill.tsv'</span><span class='op'>)</span> </span>
<span>  <span class='va'>jikoku_gps</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='va'>English</span>,<span class='va'>lon</span>,<span class='va'>lat</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span>  </span>
<span>  <span class='op'>}</span><span class='kw'>else</span><span class='op'>{</span></span>
<span>    </span>
<span><span class='va'>jikoku_gps</span> <span class='op'>&lt;-</span> <span class='va'>jikoku_clean</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='va'>hokuriku</span>, by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'Station'</span> <span class='op'>=</span> <span class='st'>'Japanese'</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>English  <span class='op'>=</span>  <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span><span class='st'>'JR '</span>, <span class='va'>English</span>,  <span class='st'>' Station,  Japan'</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#muate_geocode() searches for GPS coordinates in the supplied column of location names: </span></span>
<span>  <span class='fu'><a href='https://rdrr.io/pkg/ggmap/man/geocode.html'>mutate_geocode</a></span><span class='op'>(</span>location <span class='op'>=</span> <span class='va'>English</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>Station</span>,<span class='va'>English</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://tidyr.tidyverse.org/reference/fill.html'>fill</a></span><span class='op'>(</span><span class='va'>lon</span>,<span class='va'>lat</span>, .direction <span class='op'>=</span> <span class='st'>'down'</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'>#manual repair mis-translated: Sakudaira &amp; Annakaharuna</span></span>
<span><span class='co'>#manual repair Karuizawa: 36.34325739599876, 138.63521437877966</span></span>
<span></span>
<span><span class='va'>jikoku_gps</span> <span class='op'>&lt;-</span> <span class='va'>jikoku_gps</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>lon <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>English</span><span class='op'>==</span><span class='st'>'JR Karuizawa Station,  Japan'</span>, <span class='fl'>138.63521437877966</span>, <span class='va'>lon</span><span class='op'>)</span>,</span>
<span>         lat <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>English</span><span class='op'>==</span><span class='st'>'JR Karuizawa Station,  Japan'</span>, <span class='fl'>36.34325739599876</span>,  <span class='va'>lat</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#strip redundant text:</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>English<span class='op'>=</span><span class='fu'><a href='https://stringr.tidyverse.org/reference/str_remove.html'>str_remove_all</a></span><span class='op'>(</span><span class='va'>English</span>,<span class='st'>'JR '</span><span class='op'>)</span>,</span>
<span>         English<span class='op'>=</span><span class='fu'><a href='https://stringr.tidyverse.org/reference/str_remove.html'>str_remove_all</a></span><span class='op'>(</span><span class='va'>English</span>,<span class='st'>' Station,  Japan'</span><span class='op'>)</span><span class='op'>)</span></span>
<span>  </span>
<span><span class='fu'><a href='https://readr.tidyverse.org/reference/write_delim.html'>write_tsv</a></span><span class='op'>(</span><span class='va'>jikoku_gps</span>, <span class='st'>'project_data/j_train_lat_lon_GCPbill.tsv'</span><span class='op'>)</span></span>
<span><span class='op'>}</span></span></code></pre>
</div>
<pre><code>[1] &quot;lat_long exists, dont rerun GCP billing&quot;
# A tibble: 35 × 4
   Station    English        lon   lat
   &lt;chr&gt;      &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt;
 1 東京       Tokyo         140.  35.7
 2 上野       Ueno          140.  35.7
 3 上野       Ueno          140.  35.7
 4 大宮       Omiya         140.  35.9
 5 大宮       Omiya         140.  35.9
 6 熊谷       Kumagaya      139.  36.1
 7 熊谷       Kumagaya      139.  36.1
 8 本庄早稲田 Honjo-Waseda  139.  36.2
 9 本庄早稲田 Honjo-Waseda  139.  36.2
10 高崎       Takasaki      139.  36.3
# … with 25 more rows
# ℹ Use `print(n = ...)` to see more rows</code></pre>
</div>
<p>We can now overlay the stations on the Honshu map and zoom in on the
line:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>hokuriku_map</span> <span class='op'>&lt;-</span> <span class='va'>jikoku_gps</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>order</span>, <span class='va'>Station</span>,<span class='va'>English</span>,<span class='va'>lon</span>,<span class='va'>lat</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/distinct.html'>distinct</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'>ggplot2</span><span class='fu'>::</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x<span class='op'>=</span><span class='va'>lon</span>,y<span class='op'>=</span><span class='va'>lat</span>, group<span class='op'>=</span><span class='va'>order</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_polygon.html'>geom_polygon</a></span><span class='op'>(</span> data<span class='op'>=</span><span class='va'>JPAN</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>long</span>, y <span class='op'>=</span> <span class='va'>lat</span>, group <span class='op'>=</span> <span class='va'>group</span><span class='op'>)</span>, </span>
<span>                fill <span class='op'>=</span> <span class='st'>"white"</span>, colour <span class='op'>=</span><span class='st'>'black'</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_path.html'>geom_path</a></span><span class='op'>(</span>group<span class='op'>=</span><span class='fl'>1</span>, lty<span class='op'>=</span><span class='fl'>2</span>, col<span class='op'>=</span><span class='st'>"black"</span>, lwd<span class='op'>=</span><span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'>ggrepel</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html'>geom_text_repel</a></span><span class='op'>(</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>label<span class='op'>=</span><span class='va'>English</span>, y<span class='op'>=</span><span class='va'>lat</span>, col<span class='op'>=</span> <span class='va'>order</span><span class='op'>)</span>, nudge_y <span class='op'>=</span> <span class='fl'>0.1</span>, cex<span class='op'>=</span><span class='fl'>3</span>, </span>
<span>                            seed<span class='op'>=</span><span class='fl'>1234</span>,show.legend <span class='op'>=</span> <span class='cn'>F</span><span class='op'>)</span> <span class='op'>+</span>  </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_point.html'>geom_point</a></span><span class='op'>(</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>col<span class='op'>=</span> <span class='va'>order</span><span class='op'>)</span>, cex<span class='op'>=</span><span class='fl'>3</span>, pch<span class='op'>=</span><span class='fl'>21</span>, bg<span class='op'>=</span><span class='st'>'white'</span>, show.legend <span class='op'>=</span> <span class='cn'>F</span><span class='op'>)</span> <span class='op'>+</span> </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_viridis.html'>scale_color_viridis_c</a></span><span class='op'>(</span>end<span class='op'>=</span><span class='fl'>0.65</span>, direction <span class='op'>=</span> <span class='op'>-</span><span class='fl'>1</span><span class='op'>)</span> <span class='op'>+</span> </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>ylab</a></span><span class='op'>(</span><span class='st'>'Latitude'</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>xlab</a></span><span class='op'>(</span><span class='st'>'Longitude'</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='va'>theme_sea</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/coord_map.html'>coord_quickmap</a></span><span class='op'>(</span>xlim<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>136</span>, <span class='fl'>140.5</span><span class='op'>)</span>, ylim<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>35.15</span>,<span class='fl'>37.45</span><span class='op'>)</span><span class='op'>)</span></span>
<span>  </span>
<span><span class='va'>hokuriku_map</span></span></code></pre>
</div>
<p><img src="shinkansen_files/figure-html5/unnamed-chunk-11-1.png" width="624" /></p>
</div>
<p>While this is a fine result, there is a lot of empty space that could
be made more interesting by including Japan’s mountainous terrain- a key
element in the scenic excitement of bullet train rides. To do this
required a coding odyssey that might be the subject of another post. We
will use the resulting elevation .png file as a background for the plot
data, in place of the geom_polygon geographic outline used above.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://docs.ropensci.org/magick/'>magick</a></span><span class='op'>)</span>; <span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://www.rforge.net/png/'>png</a></span><span class='op'>)</span>; <span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>grid</span><span class='op'>)</span>; <span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://wilkelab.org/cowplot/'>cowplot</a></span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>mypng</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/png/man/readPNG.html'>readPNG</a></span><span class='op'>(</span><span class='st'>'project_charts/raster_hills_japan_latlon.png'</span><span class='op'>)</span></span>
<span><span class='va'>jpn_png_grob</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/grid/grid.raster.html'>rasterGrob</a></span><span class='op'>(</span><span class='va'>mypng</span><span class='op'>)</span></span>
<span> </span>
<span><span class='va'>hokuriku_map_elev</span> <span class='op'>&lt;-</span> <span class='va'>jikoku_gps</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>order</span>, <span class='va'>Station</span>,<span class='va'>English</span>,<span class='va'>lon</span>,<span class='va'>lat</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/distinct.html'>distinct</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x<span class='op'>=</span><span class='va'>lon</span>,y<span class='op'>=</span><span class='va'>lat</span>, group<span class='op'>=</span><span class='va'>order</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='co'>#render the elevation png image as the first layer in the plotting space</span></span>
<span>  <span class='fu'><a href='https://wilkelab.org/cowplot/reference/draw_image.html'>draw_image</a></span><span class='op'>(</span><span class='va'>mypng</span>, interpolate <span class='op'>=</span> <span class='cn'>T</span>, x <span class='op'>=</span> <span class='fl'>135.75</span>,y<span class='op'>=</span><span class='fl'>34.55</span>, width<span class='op'>=</span><span class='fl'>5</span>, height<span class='op'>=</span><span class='fl'>3.5</span><span class='op'>)</span> <span class='op'>+</span> </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_path.html'>geom_path</a></span><span class='op'>(</span>group<span class='op'>=</span><span class='fl'>1</span>, lty<span class='op'>=</span><span class='fl'>2</span>, col<span class='op'>=</span><span class='st'>"black"</span>, lwd<span class='op'>=</span><span class='fl'>0.5</span>, alpha<span class='op'>=</span><span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'>ggrepel</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html'>geom_text_repel</a></span><span class='op'>(</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>label<span class='op'>=</span><span class='va'>English</span>, y<span class='op'>=</span><span class='va'>lat</span>, col<span class='op'>=</span> <span class='va'>order</span><span class='op'>)</span>, nudge_y <span class='op'>=</span> <span class='fl'>0.1</span>, cex<span class='op'>=</span><span class='fl'>2</span>, </span>
<span>                            seed<span class='op'>=</span><span class='fl'>1234</span>,show.legend <span class='op'>=</span> <span class='cn'>F</span><span class='op'>)</span> <span class='op'>+</span>  </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_point.html'>geom_point</a></span><span class='op'>(</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>col<span class='op'>=</span> <span class='va'>order</span><span class='op'>)</span>, cex<span class='op'>=</span><span class='fl'>3</span>, pch<span class='op'>=</span><span class='fl'>21</span>, bg<span class='op'>=</span><span class='st'>'white'</span>, show.legend <span class='op'>=</span> <span class='cn'>F</span><span class='op'>)</span> <span class='op'>+</span> </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_viridis.html'>scale_color_viridis_c</a></span><span class='op'>(</span>end<span class='op'>=</span><span class='fl'>0.65</span>, direction <span class='op'>=</span> <span class='op'>-</span><span class='fl'>1</span><span class='op'>)</span> <span class='op'>+</span> </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>ylab</a></span><span class='op'>(</span><span class='st'>'Latitude'</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>xlab</a></span><span class='op'>(</span><span class='st'>'Longitude'</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/coord_map.html'>coord_quickmap</a></span><span class='op'>(</span>xlim<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>136</span>, <span class='fl'>140.5</span><span class='op'>)</span>, ylim<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>35.15</span>,<span class='fl'>37.45</span><span class='op'>)</span><span class='op'>)</span></span>
<span>  </span>
<span><span class='va'>hokuriku_map_elev</span></span></code></pre>
</div>
<p><img src="shinkansen_files/figure-html5/unnamed-chunk-12-1.png" width="100%" data-distill-preview=1 /></p>
</div>
<h3 id="calculate-inter-stop-distances">Calculate inter-stop
distances</h3>
<p>Lastly for the mapping stage, in order to interpolate the express
station pass-thru times (below), we need to calculate the distance (kM)
between each pair of consecutive stops, and the cumulative line
distance. The geosphere library allows Euclidean distance calculations
(given the lat-lon points are on a sphere).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>geosphere</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'>#calculate pairwise distances</span></span>
<span></span>
<span><span class='va'>pws_dist</span> <span class='op'>&lt;-</span> <span class='va'>jikoku_gps</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>Station</span>, <span class='va'>English</span>, <span class='va'>lat</span>, <span class='va'>lon</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/distinct.html'>distinct</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>lag_lon  <span class='op'>=</span>  <span class='fu'>lag</span><span class='op'>(</span><span class='va'>lon</span><span class='op'>)</span>,  lag_lat <span class='op'>=</span> <span class='fu'>lag</span><span class='op'>(</span><span class='va'>lat</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rowwise.html'>rowwise</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>stopDist <span class='op'>=</span> <span class='fl'>0.001</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/pkg/geosphere/man/distHaversine.html'>distHaversine</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>lon</span>,  <span class='va'>lat</span><span class='op'>)</span>,  <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>lag_lon</span>,  <span class='va'>lag_lat</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/across.html'>across</a></span><span class='op'>(</span>.cols <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>contains</a></span><span class='op'>(</span><span class='st'>'lag'</span><span class='op'>)</span>,<span class='va'>stopDist</span><span class='op'>)</span>, <span class='op'>~</span><span class='fu'><a href='https://tidyr.tidyverse.org/reference/replace_na.html'>replace_na</a></span><span class='op'>(</span><span class='va'>.x</span>, <span class='fl'>0</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>cumDist <span class='op'>=</span>  <span class='fu'><a href='https://rdrr.io/r/base/cumsum.html'>cumsum</a></span><span class='op'>(</span><span class='va'>stopDist</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code># A tibble: 18 × 8
   Station        English    lat   lon lag_lon lag_lat stopD…¹ cumDist
   &lt;chr&gt;          &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
 1 東京           Tokyo     35.7  140.      0      0      0       0   
 2 上野           Ueno      35.7  140.    140.    35.7    3.78    3.78
 3 大宮           Omiya     35.9  140.    140.    35.7   25.5    29.3 
 4 熊谷           Kumagaya  36.1  139.    140.    35.9   33.4    62.7 
 5 本庄早稲田     Honjo-W…  36.2  139.    139.    36.1   20.9    83.5 
 6 高崎           Takasaki  36.3  139.    139.    36.2   18.9   102.  
 7 安中榛名       Annakah…  36.4  139.    139.    36.3   15.3   118.  
 8 軽井沢         Karuiza…  36.3  139.    139.    36.4   19.3   137.  
 9 佐久平         Sakudai…  36.3  138.    139.    36.3   17.0   154.  
10 上田           Ueda      36.4  138.    138.    36.3   23.3   177.  
11 長野           Nagano    36.6  138.    138.    36.4   28.0   205.  
12 飯山           Iiyama    36.8  138.    138.    36.6   27.2   233.  
13 上越妙高       Joetsu-…  37.1  138.    138.    36.8   28.0   261.  
14 糸魚川         Itoigawa  37.0  138.    138.    37.1   34.6   295.  
15 黒部宇奈月温泉 Kurobe-…  36.8  138.    138.    37.0   35.4   331.  
16 富山           Toyama    36.7  137.    138.    36.8   35.4   366.  
17 新高岡         Shintak…  36.7  137.    137.    36.7   18.1   384.  
18 金沢           Kanazawa  36.6  137.    137.    36.7   36.5   421.  
# … with abbreviated variable name ¹​stopDist</code></pre>
</div>
<h1 id="how-to-train-your-animation">How to train your animation</h1>
<p>The <a
href="https://gganimate.com/articles/gganimate.html">gganimate</a>
package is a neat addition to the ggplot vocabulary. The
<code>transition_</code> geom family allows animation of data (iterative
png snap-shots) in the specified column. Given each frame is rendered
from a separate plotting call, any geoms with random jittering
(e.g. geom_jitter, ggrepel) will jump around. This is fixed by
specifying <code>seed</code> in the map call above. For this prototyping
stage, we use the ‘blank’ geographical background (no elevation) which
is faster to render and creates a much smaller gif.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://gganimate.com'>gganimate</a></span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>test_service</span> <span class='op'>&lt;-</span> <span class='va'>jikoku_gps</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>service_4</span><span class='op'>:</span><span class='va'>service_8</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#omit NA and empty cells:</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='fu'><a href='https://stringr.tidyverse.org/reference/str_detect.html'>str_detect</a></span><span class='op'>(</span><span class='va'>service_3</span>,<span class='st'>':'</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>service_3_dttm <span class='op'>=</span> <span class='fu'><a href='https://lubridate.tidyverse.org/reference/as_date.html'>as_datetime</a></span><span class='op'>(</span><span class='fu'><a href='https://lubridate.tidyverse.org/reference/hms.html'>hm</a></span><span class='op'>(</span><span class='va'>service_3</span><span class='op'>)</span> <span class='op'>)</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>ani_plt</span> <span class='op'>&lt;-</span> <span class='va'>hokuriku_map</span> <span class='op'>+</span> </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_point.html'>geom_point</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>test_service</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x<span class='op'>=</span><span class='va'>lon</span>, y<span class='op'>=</span><span class='va'>lat</span>, group <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span>, col<span class='op'>=</span><span class='st'>'red'</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://gganimate.com/reference/transition_reveal.html'>transition_reveal</a></span><span class='op'>(</span><span class='va'>service_3_dttm</span> <span class='op'>)</span></span>
<span></span>
<span><span class='fu'><a href='https://gganimate.com/reference/animate.html'>animate</a></span><span class='op'>(</span><span class='va'>ani_plt</span>, height <span class='op'>=</span> <span class='fl'>4</span>, width <span class='op'>=</span> <span class='fl'>6</span>, units <span class='op'>=</span> <span class='st'>"in"</span>, res <span class='op'>=</span> <span class='fl'>150</span>, duration<span class='op'>=</span><span class='fl'>10</span>,nframes<span class='op'>=</span><span class='fl'>100</span><span class='op'>)</span></span></code></pre>
</div>
<p><img src="shinkansen_files/figure-html5/unnamed-chunk-14-1.gif" width="100%" /></p>
</div>
<p>Now to add the all-important bullet train emoji using <a
href="https://github.com/dill/emoGG">emoGG</a>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'>#devtools::install_github('dill/emoGG')</span></span>
<span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>emoGG</span><span class='op'>)</span></span>
<span><span class='va'>ani_plt_train</span> <span class='op'>&lt;-</span> <span class='va'>hokuriku_map</span> <span class='op'>+</span> </span>
<span>  <span class='fu'>geom_emoji</span><span class='op'>(</span> data <span class='op'>=</span> <span class='va'>test_service</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x<span class='op'>=</span><span class='va'>lon</span>, y<span class='op'>=</span><span class='va'>lat</span>, group <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span>, cex<span class='op'>=</span><span class='fl'>0.04</span>, </span>
<span>              <span class='co'>#emoji='1f685') +  </span></span>
<span>              emoji<span class='op'>=</span><span class='st'>'1f686'</span><span class='op'>)</span> <span class='op'>+</span>  </span>
<span>  <span class='fu'><a href='https://gganimate.com/reference/transition_reveal.html'>transition_reveal</a></span><span class='op'>(</span><span class='va'>service_3_dttm</span> <span class='op'>)</span></span>
<span></span>
<span></span>
<span><span class='fu'><a href='https://gganimate.com/reference/animate.html'>animate</a></span><span class='op'>(</span><span class='va'>ani_plt_train</span>, height <span class='op'>=</span> <span class='fl'>4</span>, width <span class='op'>=</span> <span class='fl'>6</span>, units <span class='op'>=</span> <span class='st'>"in"</span>, res <span class='op'>=</span> <span class='fl'>150</span>, duration<span class='op'>=</span><span class='fl'>10</span>,nframes<span class='op'>=</span><span class='fl'>100</span><span class='op'>)</span></span></code></pre>
</div>
<p><img src="shinkansen_files/figure-html5/unnamed-chunk-15-1.gif" width="100%" /></p>
</div>
<p>You might have noticed that Annakaharuna station is skipped by
Service 3. This slightly annoying crack in the animation becomes a
gaping chasm when super-/express Hakutaka &amp; Kagayaki services are
added to the plotting data. They simply don’t follow the track through
the skipped stations. To remedy this required a lot of head-scratching
and some Google persistence.</p>
<h1 id="express-to-insanity">Express to insanity</h1>
<p>The timetable contains NA values for skipped stations. For services
that terminate at mid-point stations, e.g. Nagano, subsequent station
times contain blank text, not NA.</p>
<p>This problem was solved in multiple steps:<br />
1. Retain only the stations between start and terminal stations for each
service<br />
2. For express services, calculate time, distance, and thereby speed
between stops (i.e., stations where the service actually stops)<br />
3. Join the shorter express data table to the full station list, and use
average speed and distance to interpolate the clock time when the train
will pass through non-stopping stations.<br />
4. Plot the interpolated data so that each service follows the track
through all stations.</p>
<h3 id="tag-the-serviced-stations">1. Tag the serviced stations</h3>
<p>First join the timetable and station GPS coordinates, avoid distance
redundancy &amp; recode time</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># Join timetable with station gps coordinates, avoid distance redundancy &amp; recode time #</span></span>
<span></span>
<span><span class='va'>serviced_stn_time</span> <span class='op'>&lt;-</span> <span class='va'>jikoku_gps</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='va'>pws_dist</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>'lag'</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#avoid duplicating stopDist and cumDist by replacing the departure row values with 0:   </span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>stopDist <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>key</span> <span class='op'>==</span> <span class='st'>'arr'</span>, <span class='va'>stopDist</span>, <span class='fl'>0</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>cumDist  <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>key</span> <span class='op'>==</span> <span class='st'>'arr'</span>, <span class='va'>cumDist</span>,  <span class='fl'>0</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='va'>key</span>,<span class='va'>lon</span>,<span class='va'>lat</span>, <span class='va'>cumDist</span>,<span class='fu'><a href='https://tidyselect.r-lib.org/reference/everything.html'>everything</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#convert to long-form data:</span></span>
<span>  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/gather.html'>gather</a></span><span class='op'>(</span>key <span class='op'>=</span> <span class='va'>service</span> ,value <span class='op'>=</span> <span class='va'>time</span>, <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>'service_'</span><span class='op'>)</span>, na.rm <span class='op'>=</span> <span class='cn'>F</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>order</span>,<span class='va'>Station</span>,<span class='va'>English</span>,<span class='va'>key</span>,<span class='va'>lon</span><span class='op'>:</span><span class='va'>lat</span>,<span class='va'>stopDist</span>,<span class='va'>cumDist</span>,<span class='fu'><a href='https://tidyselect.r-lib.org/reference/everything.html'>everything</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#recode time (character) to datetime format:</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>time_recode <span class='op'>=</span> <span class='fu'><a href='https://lubridate.tidyverse.org/reference/as_date.html'>as_datetime</a></span><span class='op'>(</span><span class='fu'><a href='https://lubridate.tidyverse.org/reference/hms.html'>hm</a></span><span class='op'>(</span><span class='va'>time</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> </span></code></pre>
</div>
</div>
<p>Next, filter long format table to retain only stations en route for
each service:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>serviced_stn_long</span> <span class='op'>&lt;-</span> <span class='va'>serviced_stn_time</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>   </span>
<span>    <span class='co'>#First, select only stations within the service timespan, and fill up \</span></span>
<span>    <span class='co'>#  (i.e., omitting stops after mid-point termini for half-services).</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>service</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>service</span>,<span class='va'>order</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='co'>#this retains order (NA times for skipped stations are otherwise bumped to bottom)</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>route_stn <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span></span>
<span>        <span class='va'>time_recode</span> <span class='op'>==</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/na.fail.html'>na.omit</a></span><span class='op'>(</span><span class='va'>time_recode</span><span class='op'>)</span><span class='op'>)</span><span class='op'>|</span><span class='va'>time_recode</span> <span class='op'>==</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/na.fail.html'>na.omit</a></span><span class='op'>(</span><span class='va'>time_recode</span><span class='op'>)</span><span class='op'>)</span>, </span>
<span>        <span class='fl'>1</span>, <span class='fl'>0</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>    <span class='co'>#Next fill the route stations only:</span></span>
<span>  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/fill.html'>fill</a></span><span class='op'>(</span><span class='va'>route_stn</span>, .direction <span class='op'>=</span> <span class='st'>'up'</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>route_stn <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>route_stn</span><span class='op'>)</span>,<span class='st'>'y'</span>,<span class='st'>'n'</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>route_stn</span><span class='op'>!=</span><span class='st'>'n'</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#Drop the tags now the filter is complete:</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>contains</a></span><span class='op'>(</span><span class='st'>'stn'</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code># A tibble: 162 × 11
   order Station    English  key     lon   lat stopD…¹ cumDist service
   &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;    &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;  
 1     1 東京       Tokyo    dpt    140.  35.7    0       0    servic…
 2     2 上野       Ueno     arr    140.  35.7    3.78    3.78 servic…
 3     2 上野       Ueno     dpt    140.  35.7    0       0    servic…
 4     3 大宮       Omiya    arr    140.  35.9   25.5    29.3  servic…
 5     3 大宮       Omiya    dpt    140.  35.9    0       0    servic…
 6     4 熊谷       Kumagaya arr    139.  36.1   33.4    62.7  servic…
 7     4 熊谷       Kumagaya dpt    139.  36.1    0       0    servic…
 8     5 本庄早稲田 Honjo-W… arr    139.  36.2   20.9    83.5  servic…
 9     5 本庄早稲田 Honjo-W… dpt    139.  36.2    0       0    servic…
10     6 高崎       Takasaki arr    139.  36.3   18.9   102.   servic…
# … with 152 more rows, 2 more variables: time &lt;chr&gt;,
#   time_recode &lt;dttm&gt;, and abbreviated variable name ¹​stopDist
# ℹ Use `print(n = ...)` to see more rows, and `colnames()` to see all variable names</code></pre>
</div>
<h3
id="calculate-inter-stop-clock-time-distance-and-speed-for-express-services">2.
Calculate inter-stop clock time, distance and speed for express
services</h3>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># Inter-stop time, distance and speed #</span></span>
<span></span>
<span><span class='va'>stopDist_Dur_Speed_xprss</span> <span class='op'>&lt;-</span> <span class='va'>serviced_stn_long</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#skip non-stopping stations:</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>time</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#calculate distance between stopping stations (lag n = 2 allows access to cumDist value in the departure rows):</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>service</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>service</span>,<span class='va'>order</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>stopDist_xprss <span class='op'>=</span> <span class='va'>cumDist</span> <span class='op'>-</span> <span class='fu'>lag</span><span class='op'>(</span><span class='va'>cumDist</span>, n <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#update NA vals with inter-stop distance for the first rows (i.e., missed by lag(n=2)):</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>stopDist_xprss <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>stopDist_xprss</span><span class='op'>)</span>, <span class='va'>stopDist</span>, <span class='va'>stopDist_xprss</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='va'>cumDist</span>, <span class='va'>stopDist_xprss</span>, <span class='fu'><a href='https://tidyselect.r-lib.org/reference/everything.html'>everything</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#create time_lag between stopping stations:</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>time_lag <span class='op'>=</span> <span class='fu'>lag</span><span class='op'>(</span><span class='va'>time_recode</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#calculate time duration between stopping stations:</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>dur  <span class='op'>=</span>  <span class='va'>time_recode</span> <span class='op'>-</span> <span class='va'>time_lag</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#impose a 30 second duration for stations where the stop is &lt; 1 minute (i.e., arr time == dep time but NOT a skipped station):</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>dur <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>dur</span> <span class='op'>==</span> <span class='fl'>0</span>, <span class='fl'>30</span>, <span class='va'>dur</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#calculate average speed between stops:</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>avg_kpH  <span class='op'>=</span>   <span class='va'>stopDist_xprss</span> <span class='op'>/</span> <span class='op'>(</span><span class='va'>dur</span><span class='op'>/</span><span class='fl'>3600</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> </span>
<span></span>
<span><span class='va'>stopDist_Dur_Speed_xprss</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>Station</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code># A tibble: 122 × 14
   order English     key     lon   lat stopD…¹ cumDist stopD…² service
   &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;  
 1     1 Tokyo       dpt    140.  35.7    0       0       0    servic…
 2     2 Ueno        arr    140.  35.7    3.78    3.78    3.78 servic…
 3     2 Ueno        dpt    140.  35.7    0       0       0    servic…
 4     3 Omiya       arr    140.  35.9   25.5    29.3    25.5  servic…
 5     3 Omiya       dpt    140.  35.9    0       0       0    servic…
 6     4 Kumagaya    arr    139.  36.1   33.4    62.7    33.4  servic…
 7     4 Kumagaya    dpt    139.  36.1    0       0       0    servic…
 8     5 Honjo-Wase… arr    139.  36.2   20.9    83.5    20.9  servic…
 9     5 Honjo-Wase… dpt    139.  36.2    0       0       0    servic…
10     6 Takasaki    arr    139.  36.3   18.9   102.     18.9  servic…
# … with 112 more rows, 5 more variables: time &lt;chr&gt;,
#   time_recode &lt;dttm&gt;, time_lag &lt;dttm&gt;, dur &lt;dbl&gt;, avg_kpH &lt;dbl&gt;,
#   and abbreviated variable names ¹​stopDist, ²​stopDist_xprss
# ℹ Use `print(n = ...)` to see more rows, and `colnames()` to see all variable names</code></pre>
</div>
<h3
id="a.-calculate-average-travel-time-between-stops-for-all-services">3a.
Calculate average travel time between stops for all services</h3>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'>#Join all stations (serviced_stn_long) with express service inter-stop distance, duration and speed:</span></span>
<span><span class='va'>jikoku_ttime_join</span> <span class='op'>&lt;-</span> <span class='va'>serviced_stn_long</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>3</span>,<span class='va'>key</span>,<span class='va'>lat</span>,<span class='va'>lon</span>,<span class='va'>service</span>,<span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>contains</a></span><span class='op'>(</span><span class='st'>'dist'</span><span class='op'>)</span>,<span class='va'>time</span>,<span class='va'>time_recode</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#drop the stopDist and cumDist feilds which will otherwise become populated with NAs:</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='va'>stopDist_Dur_Speed_xprss</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>stopDist</span>,<span class='va'>cumDist</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#fill NA vals in avg_kpH (i.e., the average speed through non-stopping stations) \</span></span>
<span>  <span class='co'># with average speed for express services:</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>service</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>service</span>,<span class='va'>order</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/fill.html'>fill</a></span><span class='op'>(</span><span class='va'>avg_kpH</span>, .direction  <span class='op'>=</span>  <span class='st'>'up'</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#calculate the duration between stations incl. non-stopping stations</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>dur_fill  <span class='op'>=</span>  <span class='va'>stopDist</span><span class='op'>/</span><span class='op'>(</span><span class='va'>avg_kpH</span><span class='op'>/</span><span class='fl'>60</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#Division by stop time of 0 introduces NaN values. Replace these with original duration values:</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>dur_fill <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/is.finite.html'>is.nan</a></span><span class='op'>(</span><span class='va'>dur_fill</span><span class='op'>)</span>,<span class='fu'><a href='https://lubridate.tidyverse.org/reference/duration.html'>duration</a></span><span class='op'>(</span><span class='va'>dur</span><span class='op'>/</span><span class='fl'>60</span>,<span class='st'>'seconds'</span><span class='op'>)</span>,<span class='va'>dur_fill</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#convert estimated travel time to the the duration datatype</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>etime <span class='op'>=</span> <span class='fu'><a href='https://lubridate.tidyverse.org/reference/duration.html'>duration</a></span><span class='op'>(</span><span class='va'>dur_fill</span>,<span class='st'>'minutes'</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span>  </span>
<span></span>
<span><span class='co'>#Convert duration to the period data type to allow summing with date times (validation only):</span></span>
<span><span class='va'>jikoku_ttime_join</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>etime_period <span class='op'>=</span> <span class='fu'><a href='https://lubridate.tidyverse.org/reference/as.period.html'>as.period</a></span><span class='op'>(</span><span class='va'>etime</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>  <span class='co'>#this yeilds the expected station stop clock times (except for stopping stations following non-stopping ones):</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>time_add <span class='op'>=</span> <span class='va'>etime_period</span> <span class='op'>+</span> <span class='va'>time_lag</span><span class='op'>)</span>  <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>Station</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code># A tibble: 162 × 18
   order English      key     lat   lon service  stopD…¹ cumDist time 
   &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;
 1     1 Tokyo        dpt    35.7  140. service…    0       0     13:…
 2     2 Ueno         arr    35.7  140. service…    3.78    3.78 13:09
 3     2 Ueno         dpt    35.7  140. service…    0       0    13:10
 4     3 Omiya        arr    35.9  140. service…   25.5    29.3  13:28
 5     3 Omiya        dpt    35.9  140. service…    0       0    13:29
 6     4 Kumagaya     arr    36.1  139. service…   33.4    62.7  13:41
 7     4 Kumagaya     dpt    36.1  139. service…    0       0    13:42
 8     5 Honjo-Waseda arr    36.2  139. service…   20.9    83.5  13:50
 9     5 Honjo-Waseda dpt    36.2  139. service…    0       0    13:51
10     6 Takasaki     arr    36.3  139. service…   18.9   102.   14:00
# … with 152 more rows, 9 more variables: time_recode &lt;dttm&gt;,
#   stopDist_xprss &lt;dbl&gt;, time_lag &lt;dttm&gt;, dur &lt;dbl&gt;, avg_kpH &lt;dbl&gt;,
#   dur_fill &lt;dbl&gt;, etime &lt;Duration&gt;, etime_period &lt;Period&gt;,
#   time_add &lt;dttm&gt;, and abbreviated variable name ¹​stopDist
# ℹ Use `print(n = ...)` to see more rows, and `colnames()` to see all variable names</code></pre>
</div>
<h3 id="b.-interpolate-station-pass-thru-times">3b. Interpolate station
pass-thru times</h3>
<p>So far we have validated the clock times based on summing the
inter-stop duration and the previous row time data. This does not give
the clock time for the skipped stations, however, because there is not
yet an estimated duration between non-stopping stations. In this
situation, the table must be iteratively updated as the time calculation
on row n depends on the presence of data in row n-1. Amazingly, as
detailed <a
href="https://community.rstudio.com/t/row-wise-iteration-in-a-dataframe-where-each-row-depends-on-previous-values/387">here</a>,
the <code>accumulate()</code> function in the tidyverse easily
facilitates the requisite iterative row-filling:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>jikoku_fillin_long</span> <span class='op'>&lt;-</span> <span class='va'>jikoku_ttime_join</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>etime_period <span class='op'>=</span> <span class='fu'><a href='https://lubridate.tidyverse.org/reference/as.period.html'>as.period</a></span><span class='op'>(</span><span class='va'>etime</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>time_fill <span class='op'>=</span> <span class='va'>time_recode</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#this creates a vector from each column in the data frame - something like as.list()</span></span>
<span>  <span class='fu'>vctrs</span><span class='fu'>::</span><span class='fu'><a href='https://vctrs.r-lib.org/reference/vec_chop.html'>vec_chop</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='co'>#accumulate function updates the new_row based on summing etime_period and time_fill if and only if the new row contains NA:</span></span>
<span>  <span class='fu'><a href='https://purrr.tidyverse.org/reference/accumulate.html'>accumulate</a></span><span class='op'>(</span><span class='kw'>function</span><span class='op'>(</span><span class='va'>prev_row</span>,  <span class='va'>new_row</span><span class='op'>)</span><span class='op'>{</span></span>
<span>    <span class='kw'>if</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>new_row</span><span class='op'>$</span><span class='va'>time_fill</span><span class='op'>)</span><span class='op'>)</span><span class='op'>{</span></span>
<span>      <span class='va'>new_row</span><span class='op'>$</span><span class='va'>time_fill</span> <span class='op'>=</span> <span class='op'>(</span><span class='va'>prev_row</span><span class='op'>$</span><span class='va'>time_fill</span> <span class='op'>+</span> <span class='va'>new_row</span><span class='op'>$</span><span class='va'>etime_period</span><span class='op'>)</span></span>
<span>    <span class='op'>}</span><span class='kw'>else</span><span class='op'>{</span></span>
<span>      <span class='va'>new_row</span><span class='op'>$</span><span class='va'>time_fill</span> <span class='op'>=</span> <span class='va'>new_row</span><span class='op'>$</span><span class='va'>time_fill</span></span>
<span>    <span class='op'>}</span></span>
<span>    <span class='va'>new_row</span> <span class='op'>}</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/bind.html'>bind_rows</a></span><span class='op'>(</span><span class='op'>)</span> </span>
<span></span>
<span><span class='co'>#NB drop the Station column of Japanese characters which can't be rendered by this theme:</span></span>
<span><span class='va'>jikoku_fillin_long</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>Station</span><span class='op'>)</span> </span></code></pre>
</div>
<pre><code># A tibble: 162 × 18
   order English      key     lat   lon service  stopD…¹ cumDist time 
   &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;
 1     1 Tokyo        dpt    35.7  140. service…    0       0     13:…
 2     2 Ueno         arr    35.7  140. service…    3.78    3.78 13:09
 3     2 Ueno         dpt    35.7  140. service…    0       0    13:10
 4     3 Omiya        arr    35.9  140. service…   25.5    29.3  13:28
 5     3 Omiya        dpt    35.9  140. service…    0       0    13:29
 6     4 Kumagaya     arr    36.1  139. service…   33.4    62.7  13:41
 7     4 Kumagaya     dpt    36.1  139. service…    0       0    13:42
 8     5 Honjo-Waseda arr    36.2  139. service…   20.9    83.5  13:50
 9     5 Honjo-Waseda dpt    36.2  139. service…    0       0    13:51
10     6 Takasaki     arr    36.3  139. service…   18.9   102.   14:00
# … with 152 more rows, 9 more variables: time_recode &lt;dttm&gt;,
#   stopDist_xprss &lt;dbl&gt;, time_lag &lt;dttm&gt;, dur &lt;dbl&gt;, avg_kpH &lt;dbl&gt;,
#   dur_fill &lt;dbl&gt;, etime &lt;Duration&gt;, etime_period &lt;Period&gt;,
#   time_fill &lt;dttm&gt;, and abbreviated variable name ¹​stopDist
# ℹ Use `print(n = ...)` to see more rows, and `colnames()` to see all variable names</code></pre>
</div>
<h1 id="plot">PLOT!</h1>
<p>Finally we have a complete data set for plotting!</p>
<p>To make a clean time for display we will round the time_fill to 10
minute intervals:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>jikoku_fillin_long_tm</span> <span class='op'>&lt;-</span> <span class='va'>jikoku_fillin_long</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>time_fill</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span>Service<span class='op'>=</span><span class='va'>service</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>time_round <span class='op'>=</span> <span class='fu'><a href='https://lubridate.tidyverse.org/reference/round_date.html'>round_date</a></span><span class='op'>(</span><span class='va'>time_fill</span>,<span class='st'>'10 minutes'</span><span class='op'>)</span>,</span>
<span>         <span class='co'>#strip date from round time column:</span></span>
<span>         time_round <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/sprintf.html'>sprintf</a></span><span class='op'>(</span><span class='st'>"%02d"</span>,   <span class='fu'><a href='https://lubridate.tidyverse.org/reference/hour.html'>hour</a></span><span class='op'>(</span><span class='va'>time_round</span><span class='op'>)</span><span class='op'>)</span>, </span>
<span>                            <span class='fu'><a href='https://rdrr.io/r/base/sprintf.html'>sprintf</a></span><span class='op'>(</span><span class='st'>"%02d"</span>, <span class='fu'><a href='https://lubridate.tidyverse.org/reference/minute.html'>minute</a></span><span class='op'>(</span><span class='va'>time_round</span><span class='op'>)</span><span class='op'>)</span>, sep<span class='op'>=</span><span class='st'>":"</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>hokuriku_map_final</span> <span class='op'>&lt;-</span> <span class='va'>hokuriku_map_elev</span> <span class='op'>+</span> </span>
<span>  <span class='fu'>ggnewscale</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/ggnewscale/man/new_scale.html'>new_scale_colour</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'>geom_emoji</span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>jikoku_fillin_long_tm</span> , </span>
<span>             <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x<span class='op'>=</span><span class='va'>lon</span>, y<span class='op'>=</span><span class='va'>lat</span>, group<span class='op'>=</span><span class='va'>Service</span><span class='op'>)</span>, cex<span class='op'>=</span><span class='fl'>0.05</span>, </span>
<span>             <span class='co'>#emoji='1f685') +  </span></span>
<span>             emoji <span class='op'>=</span> <span class='st'>'1f686'</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='co'>#overlay a coloured square on each emoji to denote the service:</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_point.html'>geom_point</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>jikoku_fillin_long_tm</span> , </span>
<span>             <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x<span class='op'>=</span><span class='va'>lon</span>, y<span class='op'>=</span><span class='va'>lat</span>, group<span class='op'>=</span><span class='va'>Service</span>, col<span class='op'>=</span><span class='va'>Service</span><span class='op'>)</span>, </span>
<span>             <span class='co'>#pch=15, size=0.9, </span></span>
<span>             pch<span class='op'>=</span><span class='fl'>19</span>, size<span class='op'>=</span><span class='fl'>0.9</span>, </span>
<span>             show.legend <span class='op'>=</span> <span class='cn'>T</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='co'>#add a clock timer by extracting time from the datetime data: </span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_text</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>jikoku_fillin_long_tm</span> , </span>
<span>            <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x<span class='op'>=</span><span class='fl'>139.5</span>, y<span class='op'>=</span><span class='fl'>37.25</span>, group<span class='op'>=</span><span class='fl'>1</span>, </span>
<span>            label <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span><span class='st'>'JR Hokuriku Line\nTime: '</span>, <span class='va'>time_round</span><span class='op'>)</span>, hjust<span class='op'>=</span><span class='st'>'left'</span><span class='op'>)</span>,</span>
<span>          cex<span class='op'>=</span><span class='fl'>3</span>, check_overlap <span class='op'>=</span> <span class='cn'>T</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>legend.position <span class='op'>=</span> <span class='st'>'bottom'</span><span class='op'>)</span> </span>
<span></span>
<span></span>
<span><span class='va'>hokuriku_map_final</span>  </span>
<span></span>
<span><span class='fu'><a href='https://gganimate.com/reference/animate.html'>animate</a></span><span class='op'>(</span><span class='va'>hokuriku_map_final</span> <span class='op'>+</span>  <span class='fu'><a href='https://gganimate.com/reference/transition_reveal.html'>transition_reveal</a></span><span class='op'>(</span><span class='va'>time_fill</span> <span class='op'>)</span> <span class='op'>+</span> <span class='fu'><a href='https://gganimate.com/reference/ease_aes.html'>ease_aes</a></span><span class='op'>(</span><span class='st'>'cubic-in-out'</span><span class='op'>)</span> ,</span>
<span>        height <span class='op'>=</span> <span class='fl'>4</span>, width <span class='op'>=</span> <span class='fl'>6</span>, units <span class='op'>=</span> <span class='st'>"in"</span>, res <span class='op'>=</span> <span class='fl'>300</span>, </span>
<span>        duration <span class='op'>=</span> <span class='fl'>35</span> , fps<span class='op'>=</span><span class='fl'>10</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<p>Which produces the gif at the top of this post!</p>
<div class="layout-chunk" data-layout="l-body">
<p><img src="project_charts/hokuriku_anim_elev.gif" width="200%" /></p>
</div>
<p>To save the animation as a gif:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'>gganimate</span><span class='fu'>::</span><span class='fu'><a href='https://gganimate.com/reference/anim_save.html'>anim_save</a></span><span class='op'>(</span><span class='st'>'project_charts/hokuriku_anim_elev.gif'</span><span class='op'>)</span>        </span></code></pre>
</div>
</div>
<p>… only 9 shinkansen lines to go!</p>
<p><a
href="https://www.jrpass.com/assets/landing_pages/shinkansen/train_lines-88906b268c6767cf51618dde5074a4a402a85d86c0faf593eff2117121469b05.svg"><img
src="https://www.jrpass.com/assets/landing_pages/shinkansen/train_lines-88906b268c6767cf51618dde5074a4a402a85d86c0faf593eff2117121469b05.svg"
alt="Shinkansen lines" /></a></p>
<p><a href="https://tinyurl.com/shinkansenmap"
class="uri">https://tinyurl.com/shinkansenmap</a></p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>


<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom"></div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
